{% extends "base.html" %}
{% block content %}
  <h2>Upload books</h2>
  <p>
    Allowed: <strong>.pdf</strong>, <strong>.txt</strong>, <strong>.md</strong>, and <strong>.zip</strong> (containing those files).
    You can select multiple files at once. After upload, the Portal will reindex the library.
  </p>

  {% if message %}
    <article style="white-space: pre-wrap;">{{ message }}</article>
  {% endif %}

  <form id="uploadForm" method="post" enctype="multipart/form-data">
    <label style="display:block; margin: 0.75rem 0;">
      Select files (multi-select supported)
      <input id="fileInput" type="file" name="files" accept=".pdf,.txt,.md,.zip" multiple required>
    </label>

    <div id="fileList" style="font-size: 0.95rem; opacity: 0.9;"></div>

    <div style="margin: 0.75rem 0;">
      <progress id="progressBar" value="0" max="100" style="width: min(520px, 90vw); height: 18px;"></progress>
      <div id="progressText" style="margin-top: 0.35rem; font-size: 0.95rem; opacity: 0.9;"></div>
    </div>

    <button id="uploadBtn" type="submit">Upload + Reindex</button>
    <span id="spinner" style="display:none; margin-left: .6rem; opacity: 0.9;">Processing…</span>
  </form>

  <script>
    (function() {
      const form = document.getElementById("uploadForm");
      const input = document.getElementById("fileInput");
      const fileList = document.getElementById("fileList");
      const bar = document.getElementById("progressBar");
      const text = document.getElementById("progressText");
      const btn = document.getElementById("uploadBtn");
      const spinner = document.getElementById("spinner");

      function fmtBytes(n) {
        if (!Number.isFinite(n)) return "";
        const units = ["B","KB","MB","GB"];
        let u = 0;
        while (n >= 1024 && u < units.length - 1) { n /= 1024; u++; }
        return n.toFixed(u === 0 ? 0 : 1) + " " + units[u];
      }

      function refreshList() {
        const files = Array.from(input.files || []);
        if (!files.length) {
          fileList.textContent = "";
          return;
        }
        const total = files.reduce((a,f)=>a + (f.size||0), 0);
        const lines = files.slice(0, 25).map(f => `• ${f.name} (${fmtBytes(f.size||0)})`);
        if (files.length > 25) lines.push(`…and ${files.length - 25} more`);
        lines.push(`Total: ${files.length} file(s), ${fmtBytes(total)}`);
        fileList.textContent = lines.join("\n");
      }

      input.addEventListener("change", () => {
        bar.value = 0;
        text.textContent = "";
        refreshList();
      });

      form.addEventListener("submit", (e) => {
        // Use XHR so we can show upload progress.
        e.preventDefault();

        const files = Array.from(input.files || []);
        if (!files.length) return;

        bar.value = 0;
        text.textContent = "Starting upload…";
        btn.disabled = true;
        spinner.style.display = "none";

        const fd = new FormData();
        files.forEach(f => fd.append("files", f, f.name));

        const xhr = new XMLHttpRequest();
        xhr.open("POST", window.location.href, true);

        xhr.upload.onprogress = (evt) => {
          if (!evt.lengthComputable) return;
          const pct = Math.round((evt.loaded / evt.total) * 100);
          bar.value = pct;
          text.textContent = `Uploading… ${pct}% (${fmtBytes(evt.loaded)} / ${fmtBytes(evt.total)})`;
        };

        xhr.onload = () => {
          // Upload finished, server may still be extracting + reindexing.
          bar.value = 100;
          spinner.style.display = "inline";
          text.textContent = "Upload complete. Processing (extracting/reindexing)…";
          // Replace page with the HTML response so you see the message.
          document.open();
          document.write(xhr.responseText);
          document.close();
        };

        xhr.onerror = () => {
          btn.disabled = false;
          spinner.style.display = "none";
          text.textContent = "Upload failed (network error). Try again.";
        };

        xhr.send(fd);
      });

      refreshList();
    })();
  </script>

  <hr>
  <p><a href="/home_hub">Back to Home Hub</a></p>
{% endblock %}
